START TRANSACTION;

-- 检查记录是否存在
SELECT COUNT(*) INTO @record_count 
FROM feeout 
WHERE proId = '{{ipt_outAdd_proId.text}}';

IF @record_count = 0 THEN
    ROLLBACK;
    -- 记录到日志表或抛出异常
    INSERT INTO error_log (error_message, proId, created_at)
    VALUES ('未找到proId对应的记录', '{{ipt_outAdd_proId.text}}', NOW());
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '未找到对应的proId记录';
ELSE
    -- 获取最新记录
    SELECT proId, ord_no INTO @proId, @ord_no
    FROM feeout 
    WHERE proId = '{{ipt_outAdd_proId.text}}'
    ORDER BY id DESC 
    LIMIT 1
    FOR UPDATE;

    -- 插入新记录
    INSERT INTO uploadfile_detail (proId, fileLink, fileName, ord_no)
    VALUES (
        @proId,
        '{{JSON.stringify(api_upload_fapiao.data.response.file_urls.map(file => file.file_url))}}',
        '{{JSON.stringify(api_upload_fapiao.data.response.file_urls.map(file => file.original_filename))}}',
        @ord_no
    );
    
    COMMIT;
END IF;